<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<title>ğŸ’« æ™ºæ…§å°é©¬æ™ºèƒ½ä½“ Â· æ˜Ÿç©ºç»ç’ƒèˆ±ï¼ˆå¸¦æç¤ºä¸å¸®åŠ©é¢æ¿ï¼‰</title>
<style>
/* === åŸºç¡€ä¸èƒŒæ™¯ === */
:root{
  --glass-bg: linear-gradient(135deg, rgba(30,30,60,0.55), rgba(20,20,40,0.25));
  --accent: rgba(130,80,255,0.9);
}
html,body{margin:0;height:100%;width:100%;overflow:hidden;background:radial-gradient(circle at 25% 25%, #181840 0%, #000010 100%);font-family:"Segoe UI","PingFang SC","Microsoft Yahei",sans-serif;color:#fff;display:flex;align-items:center;justify-content:center}

/* æµæ˜Ÿé›¨ï¼ˆèƒŒæ™¯å°æ¡ï¼‰ */
.rain{position:absolute;animation:make-it-rain linear infinite;z-index:1}
@keyframes make-it-rain{from{top:-10%}to{top:110%}}

/* ä¸»å®¹å™¨ï¼ˆç»ç’ƒèˆ±ï¼‰ */
.container{
  position:relative;z-index:10;width:90%;max-width:820px;height:82vh;border-radius:24px;overflow:hidden;
  background:var(--glass-bg);
  box-shadow:0 0 40px rgba(150,100,255,0.25), inset 0 0 30px rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);backdrop-filter: blur(20px) saturate(180%) brightness(1.05);
  display:flex;flex-direction:column;transition:box-shadow .6s ease;
}
.container:hover{box-shadow:0 0 50px rgba(180,120,255,0.4), inset 0 0 30px rgba(255,255,255,0.06)}

/* header */
.header{
  display:flex;align-items:center;justify-content:center;gap:12px;
  background:linear-gradient(120deg, rgba(120,80,255,0.6), rgba(80,60,180,0.45));
  padding:14px 20px;font-size:20px;font-weight:600;text-shadow:0 0 6px rgba(180,150,255,0.8);
  border-bottom:1px solid rgba(255,255,255,0.08);
  position:relative;
}
.header .title-main{display:flex;align-items:center;gap:10px}
.header .help-btn{
  position:absolute;right:12px;top:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);
  color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;backdrop-filter: blur(6px);
  transition:all .2s;
}
.header .help-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(120,80,255,0.12)}

/* chat container */
.chat-container{flex:1;overflow-y:auto;padding:18px 20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}

/* messages */
.message{max-width:78%;padding:12px 16px;border-radius:16px;line-height:1.6;font-size:15px;animation:fadeIn .25s ease}
.user-message{margin-left:auto;background:linear-gradient(145deg, rgba(90,160,255,0.4), rgba(190,110,255,0.35));border:1px solid rgba(160,130,255,0.25);color:#e5e8ff;text-align:right;box-shadow:0 0 12px rgba(130,80,255,0.25), inset 0 0 10px rgba(255,255,255,0.08)}
.ai-message{margin-right:auto;background:linear-gradient(120deg, rgba(255,255,255,0.08), rgba(180,180,255,0.04));border:1px solid rgba(255,255,255,0.08);color:#f4f4f4;box-shadow:0 0 10px rgba(255,255,255,0.04)}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* hint bubble group below first AI message */
.hints {
  display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;
}
.hint {
  background:linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.06);
  padding:8px 12px;border-radius:12px;font-size:13px;color:#e8eaff;cursor:pointer;
  box-shadow:0 4px 12px rgba(60,40,120,0.08);
  transition:transform .15s,background .15s;
}
.hint:hover{transform:translateY(-4px);background:linear-gradient(135deg, rgba(130,80,255,0.18), rgba(80,40,180,0.12))}

/* input area */
.input-container{flex-shrink:0;display:flex;padding:12px 14px;background:rgba(255,255,255,0.04);border-top:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(8px)}
#user-input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:#fff;font-size:15px;outline:none;transition:all .2s}
#user-input::placeholder{color:rgba(255,255,255,0.6)}
#send-btn{margin-left:10px;padding:12px 20px;border-radius:12px;border:none;background:linear-gradient(135deg,#7e57ff,#4a22c4);color:#fff;cursor:pointer;box-shadow:0 0 12px rgba(120,80,255,0.25)}

/* code block style + copy */
.ai-message pre{position:relative;background:rgba(30,30,50,0.45);border-radius:12px;padding:14px;overflow:auto;font-family:"JetBrains Mono",Consolas,monospace;border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(10px)}
.copy-btn{position:absolute;top:8px;right:10px;background:rgba(255,255,255,0.12);border-radius:8px;padding:4px 8px;border:1px solid rgba(255,255,255,0.16);cursor:pointer;color:#fff;font-size:13px}
.copy-btn.copied::after{content:" âœ… å·²å¤åˆ¶";margin-left:6px;color:#aefba2;font-size:12px}

/* help side panel */
.help-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:40;opacity:0;pointer-events:none;transition:opacity .25s}
.help-overlay.show{opacity:1;pointer-events:auto}
.help-panel{position:fixed;right:-450px;top:0;height:100%;width:420px;background:linear-gradient(180deg,#0b0b14, #151224);box-shadow:-20px 0 40px rgba(0,0,0,0.6);z-index:50;padding:18px 18px 36px;border-left:1px solid rgba(255,255,255,0.03);transition:right .32s;overflow:auto}
.help-panel.show{right:0}
.help-panel h3{margin:6px 0 12px;font-size:18px}
.help-panel .section{margin-bottom:14px}
.help-panel .section p{color:rgba(255,255,255,0.86);line-height:1.5;font-size:14px}
.help-panel .small{font-size:13px;color:rgba(255,255,255,0.7)}

.header .help-short{font-size:12px;color:rgba(255,255,255,0.9);opacity:0.95;margin-left:6px}

/* responsive */
@media (max-width:720px){
  .container{width:96%;height:88vh;border-radius:16px}
  .help-panel{width:100%;right:-100%}
  .help-panel.show{right:0}
}
</style>
</head>
<body>

<!-- æµæ˜Ÿé›¨å…ƒç´ ï¼ˆä¼šé€šè¿‡ JS æ³¨å…¥å¤šä¸ª .rain divï¼‰ -->
<!-- ä¸»ç•Œé¢ -->
<div class="container" role="main" aria-label="æ™ºæ…§å°é©¬å¯¹è¯èˆ±">
  <div class="header">
    <div class="title-main">ğŸŒŒ <strong>æ™ºæ…§å°é©¬</strong> <span class="help-short">Â· è½¯ä»¶æ¶æ„ & ä»£ç åŠ©æ‰‹</span></div>
    <button class="help-btn" id="open-help" title="å¸®åŠ©">â“ å¸®åŠ©</button>
  </div>

  <div class="chat-container" id="chat-container" aria-live="polite">
    <div class="message ai-message" id="welcome-msg">
      ä½ å¥½ï¼æˆ‘æ˜¯æ™ºæ…§å°é©¬ï¼Œä¸“æ³¨äºè½¯ä»¶æ¶æ„è®¾è®¡ã€ä»£ç ç”Ÿæˆä¸è°ƒè¯•ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿ
      <div class="hints" id="hints">
        <!-- ç¤ºä¾‹æç¤ºæ°”æ³¡ï¼ˆæŠ€æœ¯å‘ Aï¼‰-->
        <div class="hint" data-prompt="å¸®æˆ‘è®¾è®¡ä¸€ä¸ª Spring Boot ç™»å½•æ³¨å†Œæ¨¡å—ï¼ŒåŒ…å«æ¥å£å’Œæ•°æ®åº“è¡¨è®¾è®¡ã€‚">å¸®æˆ‘è®¾è®¡ Spring Boot ç™»å½•æ¨¡å—</div>
        <div class="hint" data-prompt="è¯·å¸®æˆ‘è°ƒè¯•è¿™æ®µ Java æŠ¥é”™ï¼šNullPointerExceptionï¼Œä¸‹é¢æ˜¯ä»£ç ...">å¸®æˆ‘è°ƒè¯• Java æŠ¥é”™</div>
        <div class="hint" data-prompt="ä¸ºæˆ‘å†™ä¸€ä¸ª Vue ç™»å½•ç»„ä»¶å¹¶è¯´æ˜å¦‚ä½•ä¸åç«¯å¯¹æ¥ã€‚">å†™ä¸€ä¸ª Vue ç™»å½•ç»„ä»¶</div>
        <div class="hint" data-prompt="å¸®æˆ‘æ‰©å±•æ¯•ä¸šè®¾è®¡ã€ŠåŸºäºSpring Bootçš„å­¦ä¹ è¾…åŠ©ç³»ç»Ÿã€‹çš„åˆ›æ–°ç‚¹ä¸æŠ€æœ¯è·¯çº¿ã€‚">æ‰©å±•æ¯•ä¸šè®¾è®¡åˆ›æ–°ç‚¹</div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input id="user-input" type="text" placeholder="ç¤ºä¾‹ï¼šå¸®æˆ‘å†™ä¸€ä¸ª Spring Boot ç™»å½•æ¥å£" aria-label="è¾“å…¥ä½ çš„é—®é¢˜"/>
    <button id="send-btn">å‘é€</button>
  </div>
</div>

<!-- å³ä¾§å¸®åŠ©é¢æ¿ï¼ˆéšè—ï¼‰ -->
<div id="helpOverlay" class="help-overlay" aria-hidden="true"></div>
<aside id="helpPanel" class="help-panel" aria-hidden="true">
  <h3>ä½¿ç”¨è¯´æ˜ Â· æ™ºæ…§å°é©¬</h3>

  <div class="section">
    <p><strong>æ ¸å¿ƒèƒ½åŠ›ï¼š</strong>ä»£ç ç”Ÿæˆã€ç³»ç»Ÿè®¾è®¡ã€è°ƒè¯•åˆ†æã€éœ€æ±‚æ‹†è§£ä¸æ¥å£è®¾è®¡ã€‚å¯è¾“å‡ºä»£ç ç¤ºä¾‹ã€æ¶æ„å›¾ï¼ˆæ–‡æœ¬å½¢å¼ï¼‰ã€æµ‹è¯•å»ºè®®ä¸å®ç°æ­¥éª¤ã€‚</p>
  </div>

  <div class="section">
    <p><strong>å¦‚ä½•æé—®ï¼ˆèŒƒä¾‹ï¼‰ï¼š</strong></p>
    <p class="small">â€¢ â€œå¸®æˆ‘å†™ä¸€ä¸ª Spring Boot ç™»å½•æ¨¡å—ï¼ŒåŒ…å«ç”¨æˆ·è¡¨ã€æ¥å£å’Œç¤ºä¾‹ SQLã€‚â€</p>
    <p class="small">â€¢ â€œè¿™æ®µ Java æŠ¥é”™ NullPointerExceptionï¼Œä¸‹é¢æ˜¯ä»£ç ï¼š... è¯·å¸®æˆ‘å®šä½å¹¶ä¿®å¤ã€‚â€</p>
    <p class="small">â€¢ â€œä¸ºæˆ‘çš„æ¯•ä¸šè®¾è®¡å†™å‡º 3 ä¸ªåˆ›æ–°ç‚¹ä¸æŠ€æœ¯è½åœ°æ–¹æ¡ˆã€‚â€</p>
  </div>

  <div class="section">
    <p><strong>æç¤ºï¼š</strong></p>
    <p class="small">â€¢ è‹¥éœ€è¦ä»£ç ï¼Œè¯·ä½¿ç”¨â€œ```code```â€æˆ–åœ¨è¯·æ±‚ä¸­æ³¨æ˜è¯­è¨€ï¼ˆå¦‚ Javaã€Vueã€SQLï¼‰ã€‚</p>
    <p class="small">â€¢ æƒ³è¦ç»“æ„åŒ–è¾“å‡ºï¼ˆè¡¨æ ¼/æ­¥éª¤/æ¸…å•ï¼‰ï¼Œå¯ä»¥åŠ ä¸Šâ€œè¯·ä»¥æ­¥éª¤/è¡¨æ ¼è¾“å‡ºâ€ã€‚</p>
    <p class="small">â€¢ è‹¥è¦å¤ç°é”™è¯¯ï¼Œè¯·å°½é‡æä¾›å®Œæ•´é”™è¯¯å †æ ˆä¸å…³é”®ä»£ç ç‰‡æ®µã€‚</p>
  </div>

  <div class="section">
    <p class="small">ç‰ˆæœ¬ä¿¡æ¯ï¼šæ™ºæ…§å°é©¬ v1 Â· UIï¼šæ˜Ÿç©ºç»ç’ƒèˆ± </p>
    <p class="small">æ›´å¤šåŠŸèƒ½å°†é™†ç»­æ”¯æŒï¼šå¤šè§’è‰²åˆ‡æ¢ã€æŠ€èƒ½æ’ä»¶ã€Qwen æ¥å…¥ç¤ºä¾‹ç­‰ã€‚</p>
  </div>

  <div style="margin-top:12px">
    <button id="closeHelp" style="padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer">å…³é—­</button>
  </div>
</aside>

<!-- highlight.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Crypto for your spark signing (kept) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<!-- marked for markdown render -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
/* ---------------------------
   æµæ˜Ÿé›¨èƒŒæ™¯ç”Ÿæˆï¼ˆä¿æŒä½ åŸæ ·å¼ï¼‰
   --------------------------- */
function createRainEffect() {
  const primaryColor = { r: 131, g: 33, b: 255, a: 0.7 };
  function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
  function lightenColor(c,p){const f=1+p/100;return{r:Math.min(255,Math.floor(c.r*f)),g:Math.min(255,Math.floor(c.g*f)),b:Math.min(255,Math.floor(c.b*f)),a:c.a}}
  const num=160;
  for(let i=0;i<num;i++){
    const d=document.createElement('div');
    d.className='rain';
    const lightened=lightenColor(primaryColor,getRandomInt(1,18));
    d.style.backgroundColor=`rgba(${lightened.r},${lightened.g},${lightened.b},${lightened.a})`;
    const w=getRandomInt(1,2); const h=getRandomInt(3,14);
    d.style.width=`${w}px`; d.style.height=`${h}px`;
    d.style.left=`${getRandomInt(0,99)}%`; d.style.top=`${getRandomInt(-20,100)}%`;
    d.style.animationDuration=`${getRandomInt(3500,8000)}ms`;
    d.style.animationDelay=`-${getRandomInt(0,4000)}ms`;
    document.body.appendChild(d);
  }
}

/* ---------------------------
   DOM ready init
   --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  createRainEffect();
  initUI();
  initHighlightAndCopy(document); // åˆå§‹åŒ–é¡µé¢ä¸Šå·²æœ‰ä»£ç å—ï¼ˆå¦‚æœ‰ï¼‰
});

/* ---------------------------
   UI: hints ç‚¹å‡» / å¡«å……è¾“å…¥ / å‘é€
   --------------------------- */
function initUI(){
  const hints = document.getElementById('hints');
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');

  // ç‚¹å‡»ç¤ºä¾‹æç¤º -> å¡«å…¥è¾“å…¥æ¡†å¹¶èšç„¦
  hints.addEventListener('click', (e)=>{
    const target = e.target.closest('.hint');
    if(!target) return;
    const prompt = target.dataset.prompt || target.textContent.trim();
    input.value = prompt;
    input.focus();
    // å¯ç«‹å³å‘é€ï¼ˆè‹¥æƒ³è‡ªåŠ¨å‘é€ï¼Œåˆ™è§£é™¤æ³¨é‡Šï¼‰
    // sendBtn.click();
  });

  // placeholder æ›´å…·æŒ‡å‘æ€§ï¼ˆå·²åœ¨ HTMLï¼‰
  // å‘é€æŒ‰é’®
  sendBtn.addEventListener('click', () => {
    // è°ƒç”¨ä½ é¡µé¢çš„ sendMessage()ï¼ˆå·²ç»å®šä¹‰åœ¨åç»­è„šæœ¬ï¼‰
    sendMessage();
  });

  // Enter é”®è§¦å‘
  input.addEventListener('keypress', (e)=>{
    if(e.key === 'Enter') sendMessage();
  });

  // å¸®åŠ©é¢æ¿å¼€å…³
  const openHelp = document.getElementById('open-help');
  const helpPanel = document.getElementById('helpPanel');
  const helpOverlay = document.getElementById('helpOverlay');
  const closeHelp = document.getElementById('closeHelp');

  function open() {
    helpPanel.classList.add('show');
    helpOverlay.classList.add('show');
    helpPanel.setAttribute('aria-hidden','false');
    helpOverlay.setAttribute('aria-hidden','false');
  }
  function close() {
    helpPanel.classList.remove('show');
    helpOverlay.classList.remove('show');
    helpPanel.setAttribute('aria-hidden','true');
    helpOverlay.setAttribute('aria-hidden','true');
  }
  openHelp.addEventListener('click', open);
  closeHelp.addEventListener('click', close);
  helpOverlay.addEventListener('click', close);
}

/* ---------------------------
   é«˜äº® + å¤åˆ¶æŒ‰é’®ï¼ˆå¯¹åŠ¨æ€æ’å…¥çš„ä»£ç å—ç”Ÿæ•ˆï¼‰
   --------------------------- */
function initHighlightAndCopy(context = document){
  const blocks = context.querySelectorAll('pre code');
  blocks.forEach(block=>{
    if(!block.classList.contains('hljs')){
      try{hljs.highlightElement(block)}catch(e){}
    }
    const pre = block.closest('pre');
    if(!pre) return;
    if(!pre.querySelector('.copy-btn')){
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.type = 'button';
      btn.textContent = 'å¤åˆ¶';
      pre.appendChild(btn);
      btn.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(block.innerText);
          btn.classList.add('copied');
          setTimeout(()=>btn.classList.remove('copied'),1400);
        }catch(err){
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
      });
    }
  });
}

/* ---------------------------
   AI å¯¹è¯æ ¸å¿ƒï¼ˆä¿ç•™ä½ åŸæœ‰ Spark WebSocket è°ƒç”¨ï¼‰
   ä¸‹é¢å‡½æ•° sendMessageã€callSparkAPIã€updateLastAIMessage ç­‰
   ä¸ä½ ä¹‹å‰çš„è„šæœ¬é€»è¾‘ä¸€è‡´ â€”â€” æˆ‘ä»…åšäº†æœ€å°æ•´åˆä»¥è°ƒç”¨ initHighlightAndCopy
   --------------------------- */

const SPARK_CONFIG = {
    appId: 'd3260793',
    apiKey: '49c3edc7b32b08156d28ec793bfd1811',
    apiSecret: 'MmY4YjllNzE5YWMyNGYxMzYwMjMzZmU1',
    domain: 'generalv4',
    url: 'wss://spark-openapi.cn-huabei-1.xf-yun.com/v1/assistants/xnfsb2ts8re9_v1'
};

const chatContainer = document.getElementById('chat-container');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
let conversationHistory = [];
let ws = null;
let aiResponse = '';
let isGenerating = false;

function addMessageToUI(content, sender){
  const div = document.createElement('div');
  div.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
  div.innerHTML = content;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return div;
}

function updateLastAIMessage(content){
  const aiMsgs = chatContainer.querySelectorAll('.ai-message');
  if(aiMsgs.length > 0){
    const lastMsg = aiMsgs[aiMsgs.length - 1];
    lastMsg.innerHTML = content;
    chatContainer.scrollTop = chatContainer.scrollHeight;
    // å¯¹æœ€åæ’å…¥å†…å®¹åšé«˜äº®ä¸å¤åˆ¶æŒ‰é’®åˆå§‹åŒ–
    initHighlightAndCopy(lastMsg);
  }
}

function resetButton(){
  sendBtn.textContent = 'å‘é€';
  sendBtn.style.background = 'linear-gradient(120deg, #42a5f5, #1e88e5)';
  isGenerating = false;
}

function sendMessage(){
  if(isGenerating){
    if(ws && ws.readyState === WebSocket.OPEN){
      ws.close();
      updateLastAIMessage(renderMarkdown(aiResponse + '\n\nâšªï¼ˆå·²åœæ­¢ç”Ÿæˆï¼‰'));
    }
    resetButton();
    return;
  }
  const msg = userInput.value.trim();
  if(!msg) return;
  addMessageToUI(escapeHtml(msg), 'user');
  userInput.value = '';
  const thinking = addMessageToUI('<span class="thinking">æ­£åœ¨æ€è€ƒä¸­...</span>', 'ai');
  conversationHistory.push({role:'user', content: msg});
  sendBtn.textContent = 'â¹ åœæ­¢ç”Ÿæˆ';
  sendBtn.style.background = '#f44336';
  isGenerating = true;
  callSparkAPI(conversationHistory);
}

/* minimal escape for inserting user text into DOM (we render markdown for AI only) */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

/* Markdown render wrapper */
function renderMarkdown(text){
  try{return marked.parse(text);}
  catch(e){ return `<pre>${escapeHtml(text)}</pre>`; }
}

/* WebSocket URL generation (as before) */
function generateWebSocketURL(){
  const { apiKey, apiSecret, url: reqUrl } = SPARK_CONFIG;
  let url = new URL(reqUrl);
  let host = url.host, path = url.pathname;
  let date = new Date().toUTCString();
  let algorithm = 'hmac-sha256';
  let headers = 'host date request-line';
  let signatureOrigin = `host: ${host}\ndate: ${date}\nGET ${path} HTTP/1.1`;
  let signatureSha = CryptoJS.HmacSHA256(signatureOrigin, apiSecret);
  let signature = CryptoJS.enc.Base64.stringify(signatureSha);
  let authorizationOrigin = `api_key="${apiKey}", algorithm="${algorithm}", headers="${headers}", signature="${signature}"`;
  let authorization = btoa(authorizationOrigin);
  return `${reqUrl}?authorization=${authorization}&date=${encodeURIComponent(date)}&host=${host}`;
}

/* call spark-like websocket (keeps your original payload shape) */
function callSparkAPI(messages){
  const url = generateWebSocketURL();
  ws = new WebSocket(url);
  aiResponse = '';
  ws.onopen = ()=>{
    const requestData = {
      header:{ app_id: SPARK_CONFIG.appId, uid: Date.now().toString() },
      parameter:{ chat:{ domain: SPARK_CONFIG.domain, temperature:0.5, max_tokens:2048 } },
      payload:{ message: { text: messages } }
    };
    ws.send(JSON.stringify(requestData));
  };

  ws.onmessage = (evt)=>{
    try{
      const data = JSON.parse(evt.data);
      if(data.header && data.header.code !== 0){
        updateLastAIMessage("å‡ºé”™äº†ï¼š" + (data.header.message || 'æœªçŸ¥é”™è¯¯'));
        ws.close(); resetButton(); return;
      }
      if(!data.payload || !data.payload.choices || !data.payload.choices.text) return;
      const choices = data.payload.choices.text;
      for(let i=0;i<choices.length;i++){
        aiResponse += choices[i].content;
      }
      // streaming: header.status === 2 indicates finished in your previous code
      if(data.header.status !== 2){
        updateLastAIMessage(renderMarkdown(aiResponse));
      } else {
        ws.close();
        updateLastAIMessage(renderMarkdown(aiResponse));
        conversationHistory.push({role:'assistant', content: aiResponse});
        if(conversationHistory.length > 10) conversationHistory = conversationHistory.slice(-10);
        resetButton();
      }
    }catch(err){
      console.error('ws onmessage parse error', err);
    }
  };

  ws.onerror = ()=>{
    updateLastAIMessage('âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
    resetButton();
  };
}

/* ensure initial welcome is processed by highlight+copy (if any code) */
initHighlightAndCopy(document);

</script>
</body>
</html>   
